<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BLE 3D Plotter Pro</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: white; font-family: sans-serif; touch-action: none; }
        #ui { position: absolute; top: 0; left: 0; right: 0; z-index: 9999; background: rgba(30,30,30,0.85); padding: 8px; display: flex; gap: 5px; justify-content: center; border-bottom: 1px solid #444; }
        button { cursor: pointer; color: white; border: none; padding: 10px 5px; border-radius: 4px; font-weight: bold; font-size: 11px; flex: 1; }
        #connectBtn { background: #2196F3; }
        #startBtn { background: #E91E63; }
        #getInfoBtn { background: #FF9800; }
        #viewport { perspective: 1200px; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; }
        #world { position: relative; width: 0; height: 0; transform-style: preserve-3d; transform: translateZ(-150px) rotateX(-70deg) rotateZ(20deg); will-change: transform; }
        .grid { position: absolute; width: 300px; height: 300px; border: 1px solid #333; background-image: linear-gradient(#222 1px, transparent 1px), linear-gradient(90deg, #222 1px, transparent 1px); background-size: 30px 30px; transform: translate(-150px, -150px); }
        .axis { position: absolute; height: 2px; transform-origin: left; font-weight: bold; color: white; }
        .ball-3d { position: absolute; transform-style: preserve-3d; width: 0; height: 0; }
        .ball-p { position: absolute; width: 4px; height: 4px; background: #fff; border-radius: 50%; left: -2px; top: -2px; box-shadow: 0 0 5px #fff; }
        #log { position: absolute; bottom: 10px; left: 10px; right: 10px; font-size: 10px; color: #0f0; pointer-events: none; max-height: 80px; overflow: hidden; background: rgba(0,0,0,0.5); padding: 5px; }
    </style>
</head>
<body>

    <div id="ui">
        <button id="connectBtn">1.CONNECT</button>
        <button id="startBtn">2.START</button>
        <button id="getInfoBtn">3.GET INFO</button>
        <button id="simBtn" style="background:#4CAF50">SIM</button>
    </div>

    <div id="log">Status: Ready. Wait for connection...</div>

    <div id="viewport">
        <div id="world">
            <div class="grid"></div>
            <!-- X-Red, Y-Green, Z-Blue (Vertical) -->
            <div class="axis" style="width:150px; background:#f44; transform:rotateZ(0deg)">X</div>
            <div class="axis" style="width:150px; background:#4f4; transform:rotateZ(90deg)">Y</div>
            <div class="axis" style="width:150px; background:#44f; transform:rotateY(-90deg)">Z</div>
        </div>
    </div>

    <script>
        const world = document.getElementById('world');
        const logBox = document.getElementById('log');
        let rotX = -70, rotZ = 20, zoom = -150, lastX, lastY, lastDist = 0;
        let writeChar = null;

        function print(m) { logBox.innerHTML = "> " + m + "<br>" + logBox.innerHTML.substring(0, 300); }

        // --- 修正後的觸控邏輯 (Rotate & Zoom) ---
        const handleStart = (e) => {
            const t = e.touches ? e.touches[0] : e;
            lastX = t.clientX; lastY = t.clientY;
            if (e.touches && e.touches.length === 2) {
                lastDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            }
        };

        const handleMove = (e) => {
            if (e.target.closest('#ui')) return;
            if (e.cancelable) e.preventDefault(); // 重要：防止 iOS 頁面彈跳
            
            const t = e.touches ? e.touches : [e];
            if (t.length === 1) {
                let dx = t[0].clientX - lastX;
                let dy = t[0].clientY - lastY;
                rotZ += dx * 0.5;
                rotX -= dy * 0.5;
                lastX = t[0].clientX; lastY = t[0].clientY;
            } else if (t.length === 2) {
                let d = Math.hypot(t[0].pageX - t[1].pageX, t[0].pageY - t[1].pageY);
                zoom += (d - lastDist) * 2;
                lastDist = d;
            }
            world.style.transform = `translateZ(${zoom}px) rotateX(${rotX}deg) rotateZ(${rotZ}deg)`;
        };

        window.addEventListener('touchstart', handleStart, { passive: false });
        window.addEventListener('touchmove', handleMove, { passive: false });

        function spawnPoint(x, y, z) {
            const b = document.createElement('div');
            b.className = 'ball-3d';
            b.innerHTML = `<div class="ball-p"></div><div class="ball-p" style="transform:rotateY(90deg)"></div>`;
            const s = 80; b.style.transform = `translate3d(${x*s}px, ${y*s}px, ${z*s}px)`;
            world.appendChild(b); setTimeout(() => b.remove(), 1000);
        }

        // --- BLE 連接與自動識別 ---
        document.getElementById('connectBtn').onclick = async () => {
            try {
                print("掃描 F0FF/FFF0...");
                const device = await navigator.bluetooth.requestDevice({ 
                    acceptAllDevices: true,
                    optionalServices: [0xfff0, 0xf0ff, '0000fff0-0000-1000-8000-00805f9b34fb']
                });

                const server = await device.gatt.connect();
                print("已連接，搜尋服務...");
                
                const services = await server.getPrimaryServices();
                for (let service of services) {
                    let chars = await service.getCharacteristics();
                    for (let char of chars) {
                        // 尋找 Notify (接收數據)
                        if (char.properties.notify || char.properties.indicate) {
                            await char.startNotifications();
                            char.oncharacteristicvaluechanged = (e) => {
                                const str = new TextDecoder().decode(e.target.value);
                                print("Recv: " + str);
                                const p = str.match(/-?\d+\.\d+/g);
                                if (p && p.length >= 3) spawnPoint(parseFloat(p[p.length-3]), parseFloat(p[p.length-2]), parseFloat(p[p.length-1]));
                            };
                            print("發現讀取通道: " + char.uuid.slice(-4));
                        }
                        // 尋找 Write (發送指令)
                        if (char.properties.write || char.properties.writeWithoutResponse) {
                            writeChar = char;
                            print("發現寫入通道: " + char.uuid.slice(-4));
                        }
                    }
                }
                print("連線就緒。");
            } catch (err) { print("Error: " + err.message); }
        };

        async function send(c) {
            if (!writeChar) return print("未找到寫入通道");
            try {
                await writeChar.writeValue(new TextEncoder().encode(c + "\r\n"));
                print("Sent: " + c);
            } catch (e) { print("發送失敗: " + e.message); }
        }

        document.getElementById('startBtn').onclick = () => send("dp20");
        document.getElementById('getInfoBtn').onclick = () => send("g");
        document.getElementById('simBtn').onclick = () => {
            if (window.sIdx) { clearInterval(window.sIdx); window.sIdx = null; } 
            else { window.sIdx = setInterval(() => spawnPoint((Math.random()*2)-1, (Math.random()*2)-1, (Math.random()*2)-1), 100); }
        };
    </script>
</body>
</html>
